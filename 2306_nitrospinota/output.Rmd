---
title: "Nitrospinota"
author: "Fred Jaya"
output: 
   html_document:
     theme: spacelab
     code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = T,
  warning = F, 
  dev = 'png',
  fig.width = 8,
  fig.height = 4,
  fig.path = "/home/fredjaya/Dropbox/gtdb/02_working/2306_nitrospinota/"
  )

library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)
library(ggfortify)
library(ggrepel)
#library(plotly)
library(sem)
library(tibble)

#options(digits = 22) # For BIC precision
options(digits = 4)

aa <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", 
        "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
read_qmatrix <- function(path_to_qmatrix, iteration) {
  
  q <- read.table(path_to_qmatrix, fill = T, col.names = aa) %>%
    rbind(NA*20, .) %>%
    mutate(A2 = c(aa, "Freq")) %>%
    pivot_longer(cols = A:V, names_to = "A1", values_to = "Rate") %>%
    filter(!is.na(Rate)) %>%
    mutate(Iteration = iteration) %>%
    add_row(A2 = "A", A1 = "V", Rate = NA, Iteration = iteration) %>%
    mutate(A1 = factor(A1, levels = (c(aa,"Freq")))) %>%
    mutate(A2 = factor(A2, levels = rev(c(aa, "Freq"))))
}

read_q_pca <- function(filename) {
  # Rob's code for qMaker paper
  # read lower-diagonal matrix
  Q = readMoments(filename, diag=F)
  pi = Q[nrow(Q), 1:(ncol(Q)-1)]
  Q = Q[1:(nrow(Q)-1), 1:(ncol(Q)-1)]
  # make Q symmetric
  Q = (Q + t(Q))
  diag(Q) <- 0
  # normalise the matrix
  Q=(Q/sum(Q))*100.0
  return(rbind(Q, pi))
}

theme_fj <- 
  theme_minimal() +
  theme(text=element_text(size=18))
```

# Branch lengths  
- [ ] Read in pruned tree  
- [ ] Get total branch length
- [ ] Distribution of branch length  

# Locus stats  

```{r, alistat}
alistat <- 
  read.csv("work/a5/a6ebf6123cee9f7cf0dcfad1af6a60/nitrospinota_alistats.csv", header = F)
colnames(alistat) <- c("Locus", "Sequences", "Sites", "Ca", "Cr_max", "Cr_min", "Cc_max", "Cc_min", "Cij_max", "Cij_min")

alistat <- 
  alistat[order(-alistat$Ca), ] %>%
  mutate(Set = if_else(Locus %in% tail(Locus, 20), "Testing", "Training"))

alistat %>%
  ggplot(aes(x = Sites, y = Ca, col = Set)) +
  geom_point(size = 2) +
  coord_cartesian(ylim = c(0,1)) +
  labs(x = "Number of sites in locus", y = "Completenes (Ca)", title = "Alistat: subsetting loci for training/testing") +
  theme_fj
```

$C_a=$ Number of unambiguous characters in the alignment $(m*n)$  
$C_r=$ Number of unambiguous characters in a sequence $(n)$  
$C_c=$ Number of unambiguous characters in a site $(m)$  
$C_{ij}=$ Pairwise matrix of unambiguous characters between sequences  

## Training  
```{r training_loci}
train_stats <- 
  read.table("training_stats.txt", sep="\t", header = T) %>%
  select(Locus = Name, `Training sequences` = Seqs, `Training sites` = Sites, Infor, Invar) %>%
  mutate(Prop_informative = Infor/`Training sites`)

ali_train <- 
  alistat %>%
  left_join(train_stats, by = "Locus") 

ali_train %>%
  ggplot(aes(y = `Training sequences`, x = `Training sites`, col = Prop_informative)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  labs(title = "IQ-TREE-filtered training loci for the best Q-matrix") +
  theme_fj
```

```{r bic_iter}
bic <- read.table("bic_per_iter.txt", header = T)
bic %>%
  ggplot(aes(x = Iteration, y = BIC)) +
  geom_line(size = 1) +
  labs(title = "Training Q BIC over iterations") +
  theme_fj
```

```{r q_iter_prep}
#TODO: Softcode best iteration  

q1 <- read_qmatrix("work/24/dabaa964db04fc10bd9a40a3f65ae6/Q.bac_locus_i1", 1)
#plot_qmatrix(q1, 1)
qbest <- read_qmatrix("work/24/dabaa964db04fc10bd9a40a3f65ae6/Q.bac_locus_i4", 4)
#plot_qmatrix(qbest, 4)

q1_qbest <- rbind(q1, qbest) %>% mutate(Iteration = as.factor(Iteration))
rm(q1, qbest)  
```

```{r q_dist}
q1_qbest %>%
  filter(A2 != "Freq") %>%
  ggplot(aes(x=Rate, fill=Iteration, col =Iteration)) +
  #\geom_histogram(position = "dodge", bins = 100) +
  geom_density(alpha = 0.2, size = 1) +
  labs(title = "Distribution of rates between the first and best iteration",
       y = "Density") +
  theme_fj
```

```{r q_rates, fig.height=5}
q1_qbest %>%
  filter(A2 != "Freq") %>%
  ggplot(aes(x=A1, y=A2,size=Rate, color=Iteration)) +
  geom_jitter(alpha=0.7, width = 0.15, height = 0.15) +
  theme_fj +
  labs(title = "Substitution rates between the first and best iteration")
```

```{r freqs, fig.height=3}
q1_qbest %>%
  filter(A2 == "Freq") %>%
  ggplot(aes(x=A1, y=Rate, fill=Iteration)) +
  geom_col(position = "dodge") +
  labs(y= "Frequency") +
  labs(title = "Frequencies between the first and best iteration") +
  theme_fj
```

# Comparison with existing rates  

```{r pca_prep}
q_dir = "~/GitHub/gtdb_trees/data/q/Q"
filenames <- list.files(path = q_dir, full.names = TRUE)

allQ = NULL
allF = NULL

for (f in filenames) {
  #print(f)
  Q_pi = read_q_pca(f)
  Q = Q_pi[1:(nrow(Q_pi)-1),]
  pi = Q_pi[nrow(Q_pi),]
  allQ = rbind(allQ, Q[lower.tri(Q)])
  allF = rbind(allF, pi)
}

# Read qNew
Q_pi <- read_q_pca("work/24/dabaa964db04fc10bd9a40a3f65ae6/Q.bac_locus_i4")
Q = Q_pi[1:(nrow(Q_pi)-1),]
pi = Q_pi[nrow(Q_pi),]
allQ = rbind(allQ, Q[lower.tri(Q)])
allF = rbind(allF, pi)

rownames(allQ) <- c(gsub(".*\\/", "", filenames), "nitrospinota")
rownames(allF) <- c(gsub(".*\\/", "", filenames), "nitrospinota")

general = c("DAYHOFF", "VT", "PMB", "BLOSUM62", "DCMUT", "JTTDCMUT", "POISSON", 
            "Q.PFAM", "Q.LG", "Q.PFAM_GB", "WAG", "JTT", "LG")
#general_best = c("WAG", "JTT", "LG")
mitochondrial = c("MTREV", "MTMAM", "MTART", "MTZOA", "MTMET" , "MTVER" , "MTINV")
chloroplast = c("CPREV")
viral = c("HIVB", "HIVW", "FLU", "RTREV", "FLAVI")
clade = c("Q.BIRD", "Q.INSECT", "Q.MAMMAL", "Q.PLANT", "Q.YEAST")
q_new = c("nitrospinota")

allQ2 <- 
  as.data.frame(allQ) %>% 
  rownames_to_column(var = "Model") %>% 
  mutate(category = case_when(
    Model %in% general ~ "general",
    #Model %in% general_best ~ "general_best",
    Model %in% mitochondrial ~ "mitochondrial",
    Model %in% chloroplast ~ "chloroplast",
    Model %in% viral ~ "viral",
    Model %in% clade ~ "clade",
    Model %in% q_new ~ "q_new"
  ))

allF2 <- 
  as.data.frame(allF) %>% 
  rownames_to_column(var = "Model") %>% 
  mutate(category = case_when(
    Model %in% general ~ "general",
    #Model %in% general_best ~ "general_best",
    Model %in% mitochondrial ~ "mitochondrial",
    Model %in% chloroplast ~ "chloroplast",
    Model %in% viral ~ "viral",
    Model %in% clade ~ "clade",
    Model %in% q_new ~ "q_new"
  ))
```

```{r pcas, fig.height=5}
autoplot(prcomp(allQ), data=allQ2, main="PCA of new and existing exchangeability rates", colour = "category") +
  geom_text_repel(aes(label = Model, color=category), max.overlaps = Inf,
                  size = ifelse(allQ2$category == "q_new", 6, 3)) +
  theme_fj

autoplot(prcomp(allF), data=allF2, main="PCA of new and existing frequencies", colour = "category") +
  geom_text_repel(aes(label = Model, color=category), max.overlaps = Inf,
                  size = ifelse(allQ2$category == "q_new", 6, 3)) +
  theme_fj
```
```{r}
colnames(allF2) <- c("Model", aa, "category")

allF2_long <- pivot_longer(allF2, cols = A:V)

allF2_long %>%
  ggplot(aes(x = name, y = value)) +
  geom_boxplot(size=1) +
  geom_point(data = . %>% filter(category == "q_new"), shape = 18, color="red", size=3 ) +
  labs(x = "Amino acid", y = "Frequencies", 
       title = "Frequencies of new and existing Q-matrices", 
       caption = "Boxplot = 31 existing freqs\nRed diamond = Estimated freq") +
  theme_fj
```

